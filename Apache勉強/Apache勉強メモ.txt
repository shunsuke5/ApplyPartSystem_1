Apache勉強メモ

・The default folder for your your webpages is DocumentRoot "c:/Apache24/htdocs"
　と書いてあるため、公開するwebページはここに置く？

・コマンドプロンプトで「c:\Apache24\bin」に移動し、httpd.exe コマンドを打つとサーバーが開始する。
　http://localhost をブラウザで検索し、It works!のように表示されれば成功。
　ctrl + c でサーバーは閉じることができる。

・windowsにApacheサービスをインストールする時は「httpd.exe -k install」コマンドを使用。

・「services.msc」コマンドでApacheサービスを起動/停止できる。

・「httpd -h」コマンドでヘルプを見ることができる。

・Apacheは起動時に、ローカルマシンのあるポート及びアドレスに対して接続し、リクエストが来るのを待つ。
　デフォルトではマシンの全てのアドレスに対してListenする。(Listen 80)
　特定のポート、特定のアドレス、またはそれらの組み合わせでListenするように指定したい場合もある。
　異なるIPアドレス、ホスト名、ポートに対してApacheがどのように応答するかを制御する「バーチャルホスト機能」
　と組み合わせてよく使用される。

　「Listenディレクティブ」で特定のポートやアドレス、ポートの組から入ってくるリクエストのみを受け付けるようにできる。
　もしポート番号だけがListenディレクティブで指定された場合は(例:Listen 80)、
　全てのインターフェースの与えられたポート番号に対してListenする。
　Listenディレクティブを複数使ってListenするアドレスとポートをいくつも指定できる。
　サーバは指定されたアドレスやポートからのリクエスト全てに対して応答する。
　例えば、Listen 80 と Listen8000 とした場合、全てのインターフェースのポート80と8000において接続を受け付ける。
　Listen 192.0.2.1:80 と Listen 192.0.2.5:8000 とした場合、
　192.0.2.1インターフェースでは80番ポートで接続を受け付け、192.0.2.5インターフェースでは8000番ポートで接続を受け付ける。
　IPv6アドレスは Listen [2001:db8::a00:20ff:fea7:ccea]:80 のように角かっこで囲まなければいけない。

・Listenディレクティブでバーチャルホストが実装されるわけではない。Listenは単にメインサーバーにどのアドレスとポートを
　Listenすべきかを教えるだけ。<VirtualHost>ディレクティブが使われない場合は、受け入れたリクエスト全てに対して全く同じ挙動をする。
　VirtualHostを実装するには、まず初めに使用したいアドレスとポートに対してサーバがListenしていなければならない。
　そして、その指定したアドレスとポートでのバーチャルホストの挙動を設定するために<VirtualHost>セクションを作成する。
　もしVirtualHostがListenしていないアドレスとポートに対して設定されてしまうと、それにはアクセスできないと言う点に注意する。

・Apacheの設定ファイルは1行に1つのディレクティブからなる。バックスラッシュはディレクティブが次の行に継続していることを
　示すために行の最後の文字として使われている可能性がある。#で始まる行はコメント行。
　設定ディレクティブと同一行の末尾にコメントが含まれていてはいけない。
　ディレクティブの前の空行と空白は無視されるため、わかりやすくするためにインデントをしても問題ない。

・設定ファイルの構文エラーは、apachectl configtest かコマンドライン -t を使って調べられる。

・メイン設定ファイルにあるディレクティブはサーバ全体に適用される。サーバの一部分の設定だけを
　変更したい場合は、<Directory>,<DirectoryMatch>,<Files>,<FilesMatch>,<Location> 中にある
　ディレクティブの適用範囲を特定のファイルシステムの位置やURLに限定する。細かい設定を可能にするため、
　セクションを入れ子にすることもできる。

・Apacheは同時に多くの違うwebサイトを扱う能力がある。これは「バーチャルホスト」と呼ばれている。
　特定のウェブサイトにのみ適用されるようにするために、ディレクティブは<VirtualHost>セクションの中に置くことでも
　適用範囲を変えることができる。

・ほとんどのディレクティブはどのセクションにでも書けるが、中にはコンテキストによっては意味をなさないものもある。
　例えば、プロセスの作成を制御しているディレクティブはメインサーバのコンテキストにのみ書くことができる。
　どのディレクティブをどのセクションに書くことができるかを知るためには、ディレクティブの「コンテキスト」を調べる。

・上記のように、設定ファイル中のディレクティブはサーバ全体に適用されたり、特定のディレクトリやファイル、ホスト、
　URLにのみ適用されるように制限したりすることができる。

・設定用セクションコンテナの種類

　コンテナには2つの基本となる種類がある。ほとんどのコンテナは各リクエストに対して評価される。
　その場合、コンテナ中のディレクティブはコンテナにマッチするリクエストにのみ適用される。
　一方、<IfDefine>,<IfModule>,<IfVersion>コンテナはサーバの起動時と再起動時にのみ評価される。
　起動時に条件が真であれば、コンテナ中のディレクティブは全てのリクエストに適用される。
　条件が偽であれば、コンテナ中のディレクティブは無視される。

・<IfDefine>ディレクティブはhttpdコマンドラインで適切なパラメータが定義されたときにのみ、適用されるディレクティブを囲う。
　例えば以下の設定では、サーバがhttpd -DClosedForNow を使って起動されたときだけ全てのリクエストを別のサイトにリダイレクトする。

　　<IfDefine ClosedForNow>
    Redirect / http://otherserver.example.com/
    </IfDefine>

　<IfModule>は非常に似ているが、代わりにサーバ上でモジュールが使用可能な場合にのみ、適用可能なディレクティブを囲う。
　モジュールはサーバに静的に組み込まれているか、動的に組み込むようになっていて、設定ファイル中でLoadModuleの行が
　前の部分に書かれている必要がある。
　以下の例では mod_mime_magic があるときにのみMimeMagicFilesディレクティブが適用される。

　　<IfModule mod_mime_magic.c>
    MimeMagicFile conf/magic
    </IfModule>

　<IfVersion>ディレクティブは<IfDefine>や<IfModule>とよく似ているが、稼働中のサーバのバージョンが特定のバージョン時にのみ
　適用される。様々なバージョンのhttpdを様々な設定で動作させることになる場合で、テストスイートや巨大なネットワークでの用途を
　想定して、このモジュールは設計されている。例としては以下の通り。

　　<IfVersion >= 2.1>
        # this happens only in versions greater or
        # equal 2.1.0.
    </IfVersion>

・ファイルシステムとweb空間

　最もよく使われる設定のセクションコンテナは、ファイルシステムやweb空間の特定の場所の設定を変更するものである。
　まず、この2つの違いを理解することが大切。ファイルシステムはOSから見たディスクの内容。例えば、デフォルトのインストールでは
　ApacheはUnixファイルシステムでは/usr/local/apache2に、Windowsファイルシステムではc:/ProgramFiles/Apache Group/Apache2
　に存在する。(ApacheではWindowsでもパスセパレータとして/を使うことに気を付ける)
　対して、web空間はあなたのサイトをwebサーバから配信されるものとして持たもので、クライアントに見えるものである。
　デフォルトのUnix上のApacheのインストールではweb空間の/dir/というパスはファイルシステムの
　/usr/local/apache2/htdocs/dir/というパスに対応する。webページはデータベースや他の場所から動的に生成することもできるので、
　web空間はファイルシステムに直接マップする必要はない。

・ファイルシステムコンテナ

　<Directory>ディレクティブと<Files>ディレクティブ、それらの正規表現版はディレクティブをファイルシステムの
　一部分に対して適用する。<Directory>セクションの中のディレクティブは指定されたディレクトリとそのすべてのサブディレクトリに適用される。
　.htaccessファイルを使うことでも同じ効果を得ることができる(.htaccessファイルは極力使用しないことが推奨されている。)
　例えば、以下の設定では/var/web/dir1 とすべてのサブディレクトリに対してディレクトリインデックスを行う。

　　<Directory /var/web/dir1>
    Options +Indexes
    </Directory>

============================================================================================================================

エラーやミス、わからないことなど

・httpd -k install コマンドでwindowsにapacheサービスをインストールしたとき、以下のようなエラーが出た。

　　C:\Windows\System32>httpd -k install
　　Installing the 'Apache2.4' service
　　The 'Apache2.4' service is successfully installed.
　　Testing httpd.conf....
　　Errors reported here must be corrected before the service can be started.
　　AH00558: httpd: Could not reliably determine the server's fully qualified domain name, 
　　using fe80::bb83:36d0:35ca:b0dc. Set the 'ServerName' directive globally to suppress this message

　→ 恐らく、httpd.confの設定をしていなかったため、このエラーが出たのだと思われる。