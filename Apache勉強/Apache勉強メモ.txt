Apache勉強メモ

・The default folder for your your webpages is DocumentRoot "c:/Apache24/htdocs"
　と書いてあるため、公開するwebページはここに置く？

・コマンドプロンプトで「c:\Apache24\bin」に移動し、httpd.exe コマンドを打つとサーバーが開始する。
　http://localhost をブラウザで検索し、It works!のように表示されれば成功。
　ctrl + c でサーバーは閉じることができる。

・windowsにApacheサービスをインストールする時は「httpd.exe -k install」コマンドを使用。

・「services.msc」コマンドでApacheサービスを起動/停止できる。

・「httpd -h」コマンドでヘルプを見ることができる。

・Apacheは起動時に、ローカルマシンのあるポート及びアドレスに対して接続し、リクエストが来るのを待つ。
　デフォルトではマシンの全てのアドレスに対してListenする。(Listen 80)
　特定のポート、特定のアドレス、またはそれらの組み合わせでListenするように指定したい場合もある。
　異なるIPアドレス、ホスト名、ポートに対してApacheがどのように応答するかを制御する「バーチャルホスト機能」
　と組み合わせてよく使用される。

　「Listenディレクティブ」で特定のポートやアドレス、ポートの組から入ってくるリクエストのみを受け付けるようにできる。
　もしポート番号だけがListenディレクティブで指定された場合は(例:Listen 80)、
　全てのインターフェースの与えられたポート番号に対してListenする。
　Listenディレクティブを複数使ってListenするアドレスとポートをいくつも指定できる。
　サーバは指定されたアドレスやポートからのリクエスト全てに対して応答する。
　例えば、Listen 80 と Listen8000 とした場合、全てのインターフェースのポート80と8000において接続を受け付ける。
　Listen 192.0.2.1:80 と Listen 192.0.2.5:8000 とした場合、
　192.0.2.1インターフェースでは80番ポートで接続を受け付け、192.0.2.5インターフェースでは8000番ポートで接続を受け付ける。
　IPv6アドレスは Listen [2001:db8::a00:20ff:fea7:ccea]:80 のように角かっこで囲まなければいけない。

・Listenディレクティブでバーチャルホストが実装されるわけではない。Listenは単にメインサーバーにどのアドレスとポートを
　Listenすべきかを教えるだけ。<VirtualHost>ディレクティブが使われない場合は、受け入れたリクエスト全てに対して全く同じ挙動をする。
　VirtualHostを実装するには、まず初めに使用したいアドレスとポートに対してサーバがListenしていなければならない。
　そして、その指定したアドレスとポートでのバーチャルホストの挙動を設定するために<VirtualHost>セクションを作成する。
　もしVirtualHostがListenしていないアドレスとポートに対して設定されてしまうと、それにはアクセスできないと言う点に注意する。

・Apacheの設定ファイルは1行に1つのディレクティブからなる。バックスラッシュはディレクティブが次の行に継続していることを
　示すために行の最後の文字として使われている可能性がある。#で始まる行はコメント行。
　設定ディレクティブと同一行の末尾にコメントが含まれていてはいけない。
　ディレクティブの前の空行と空白は無視されるため、わかりやすくするためにインデントをしても問題ない。

・設定ファイルの構文エラーは、apachectl configtest かコマンドライン -t を使って調べられる。

・メイン設定ファイルにあるディレクティブはサーバ全体に適用される。サーバの一部分の設定だけを
　変更したい場合は、<Directory>,<DirectoryMatch>,<Files>,<FilesMatch>,<Location> 中にある
　ディレクティブの適用範囲を特定のファイルシステムの位置やURLに限定する。細かい設定を可能にするため、
　セクションを入れ子にすることもできる。

・Apacheは同時に多くの違うwebサイトを扱う能力がある。これは「バーチャルホスト」と呼ばれている。
　特定のウェブサイトにのみ適用されるようにするために、ディレクティブは<VirtualHost>セクションの中に置くことでも
　適用範囲を変えることができる。

・ほとんどのディレクティブはどのセクションにでも書けるが、中にはコンテキストによっては意味をなさないものもある。
　例えば、プロセスの作成を制御しているディレクティブはメインサーバのコンテキストにのみ書くことができる。
　どのディレクティブをどのセクションに書くことができるかを知るためには、ディレクティブの「コンテキスト」を調べる。

・上記のように、設定ファイル中のディレクティブはサーバ全体に適用されたり、特定のディレクトリやファイル、ホスト、
　URLにのみ適用されるように制限したりすることができる。

・設定用セクションコンテナの種類

　コンテナには2つの基本となる種類がある。ほとんどのコンテナは各リクエストに対して評価される。
　その場合、コンテナ中のディレクティブはコンテナにマッチするリクエストにのみ適用される。
　一方、<IfDefine>,<IfModule>,<IfVersion>コンテナはサーバの起動時と再起動時にのみ評価される。
　起動時に条件が真であれば、コンテナ中のディレクティブは全てのリクエストに適用される。
　条件が偽であれば、コンテナ中のディレクティブは無視される。

・<IfDefine>ディレクティブはhttpdコマンドラインで適切なパラメータが定義されたときにのみ、適用されるディレクティブを囲う。
　例えば以下の設定では、サーバがhttpd -DClosedForNow を使って起動されたときだけ全てのリクエストを別のサイトにリダイレクトする。

　　<IfDefine ClosedForNow>
    Redirect / http://otherserver.example.com/
    </IfDefine>

　<IfModule>は非常に似ているが、代わりにサーバ上でモジュールが使用可能な場合にのみ、適用可能なディレクティブを囲う。
　モジュールはサーバに静的に組み込まれているか、動的に組み込むようになっていて、設定ファイル中でLoadModuleの行が
　前の部分に書かれている必要がある。
　以下の例では mod_mime_magic があるときにのみMimeMagicFilesディレクティブが適用される。

　　<IfModule mod_mime_magic.c>
    MimeMagicFile conf/magic
    </IfModule>

　<IfVersion>ディレクティブは<IfDefine>や<IfModule>とよく似ているが、稼働中のサーバのバージョンが特定のバージョン時にのみ
　適用される。様々なバージョンのhttpdを様々な設定で動作させることになる場合で、テストスイートや巨大なネットワークでの用途を
　想定して、このモジュールは設計されている。例としては以下の通り。

　　<IfVersion >= 2.1>
        # this happens only in versions greater or
        # equal 2.1.0.
    </IfVersion>

・ファイルシステムとweb空間

　最もよく使われる設定のセクションコンテナは、ファイルシステムやweb空間の特定の場所の設定を変更するものである。
　まず、この2つの違いを理解することが大切。ファイルシステムはOSから見たディスクの内容。例えば、デフォルトのインストールでは
　ApacheはUnixファイルシステムでは/usr/local/apache2に、Windowsファイルシステムではc:/ProgramFiles/Apache Group/Apache2
　に存在する。(ApacheではWindowsでもパスセパレータとして/を使うことに気を付ける)
　対して、web空間はあなたのサイトをwebサーバから配信されるものとして持たもので、クライアントに見えるものである。
　デフォルトのUnix上のApacheのインストールではweb空間の/dir/というパスはファイルシステムの
　/usr/local/apache2/htdocs/dir/というパスに対応する。webページはデータベースや他の場所から動的に生成することもできるので、
　web空間はファイルシステムに直接マップする必要はない。

・ファイルシステムコンテナ

　<Directory>ディレクティブと<Files>ディレクティブ、それらの正規表現版はディレクティブをファイルシステムの
　一部分に対して適用する。<Directory>セクションの中のディレクティブは指定されたディレクトリとそのすべてのサブディレクトリに適用される。
　.htaccessファイルを使うことでも同じ効果を得ることができる(.htaccessファイルは極力使用しないことが推奨されている。)
　例えば、以下の設定では/var/web/dir1 とすべてのサブディレクトリに対してディレクトリインデックスを行う。

　　<Directory /var/web/dir1>
    Options +Indexes
    </Directory>

　<Files>セクションの中にあるディレクティブはどのディレクトリにあるかに関わらず、指定された名前の全てのファイルに適用される。
　例えば、以下の設定ディレクティブが設定ファイルの主セクションに書かれたときには、全ての場所のprivate.htmlという名前の
　ファイルへのアクセスを拒否する。

　　<Files private.html>
    Order allow,deny
    Deny from all
    </Files>

　ファイルシステムの特定の場所にあるファイルを指定するために、<Files>セクションと<Directory>セクションを組み合わせることができる。
　例えば以下の設定では、/var/web/dir1 ディレクトリの下にあるすべてのprivate.htmlへのアクセスを拒否する。

　　<Directory /var/web/dir1>
    <Files private.html>
    Order allow,deny
    Deny from all
    </Files>
    </Directory>

・web空間コンテナ

　一方、<Location>ディレクティブとその正規表現版は、web空間上の内容に対して設定を変更する。
　例えば、以下の設定では/privateで始まるURLパスへのアクセスを制限する。

　　<Location /private>
    Order Allow,Deny
    Deny from all
    </Location>

　<Location>ディレクティブはファイルシステムと関係ある必要が全くない。
　例えば以下の例では、どのようにして特定のURLをmod_statusで提供されているApache内部ハンドラにマップするかを示している。
　ファイルシステムにserver-statusというファイルが存在する必要はない。

　　<Location /server-status>
    SetHandler server-status
    </Location>

・ワイルドカードと正規表現

　<Directory>,<Files>,<Location>ディレクティブでは、C標準ライブラリのfnmatchのように
　shellスタイルのワイルドカードキャラクタが使用できる。*は任意の文字列にマッチし、?は任意の1文字にマッチし、
　[seq]はseqの任意の文字にマッチする。/はどのワイルドカードでもマッチされない。明示的に指定する必要がある。
　これより柔軟なマッチングが必要な場合は、これらのコンテナに正規表現(regex)版である
　<DirectoryMatch>,<FilesMatch>,<LocationMatch>があり、regexセクションを使用することで、ディレクティブの適用が
　どのように変化するかを把握することが重要。
　全ユーザディレクトリの設定を変更する、非regexワイルドカードセクションは以下の通り。

　　<Directory /home/*/public_html>
    Options Indexes
    </Directory>

　以下のようにregexセクションを使用することで、画像ファイルの多くのタイプに対するアクセスを一度に拒否できる。

　　<FilesMatch \.(?i:gif|jpe?g|png)$>
    Order allow,deny
    Deny from all
    </FilesMatch>

・いつ何を使うか

　ファイルシステムコンテナとweb空間コンテナを使い分けるのは、実際には非常に簡単。
　ファイルシステムに依存するオブジェクトにディレクティブを適応する場合は、必ず<Directory>か<Files>を使用する。
　ファイルシステムに依存しないオブジェクト(データベースから生成されるwebページなど)に
　ディレクティブを適用する際には<Location>を使用する。

　ファイルシステム上のオブジェクトへのアクセスを制限するために、<Location>を決して使用しないように注意する。
　同一のファイルシステム位置にマップしている、web空間位置(URL)が多数あり、
　設定した制限を迂回されてしまうかもしれないから。例えば以下の設定を考えてみる。

　　<Location /dir/>
    Order allow,deny
    Deny from all
    </Location>

　http://yoursite.example.com/dir/へのリクエストではうまく動作する。
　しかし大文字小文字を区別しないファイルシステムを使っていたらどうなるだろうか？
　http://yoursite.example.com/DIR/へのリクエストで簡単にアクセス制限を迂回されてしまう。
　これに対して<Directory>ディレクティブを使用すると、どのように呼び出されたかに関わらずその場所から提供される
　内容に適用される。

　※例外としてファイルシステムのリンクがある。シンボリックリンクを使って、同一のディレクトリを複数のファイルシステムに
　設置できる。<Direcory>ディレクティブはパス名をリセットすることなくシンボリックリンクを辿るため、
　高度なセキュリティが要求される場合は、適切にOptionsディレクティブを使用してシンボリックリンクを無効にするべき。

・バーチャルホスト

　<VirtualHost>コンテナは特定のホストに適用するディレクティブを格納する。
　一台のマシンで複数のホストを異なる設定で提供したい時に有用。

・プロクシ

　<Proxy>と<ProxyMatch>コンテナは、特定のURLにマッチするmod_proxyプロクシサーバを経由して
　アクセスしたサイトに対してのみ適用される設定ディレクティブを格納する。
　例えば以下の設定は、cnn.comウェブサイトにアクセスするために用いられるプロクシサーバを制限する。

　　<Proxy http://cnn.com/*>
    Order allow,deny
    Deny from all
    </Proxy>

　プロキシとは、「代理」という意味で、インターネットを接続する際に、ネットワークの内部から
　外部へのアクセスを代理で行うシステムのこと。プロキシサーバとも呼ばれ、企業がサイバー攻撃などに対抗し、
　自社の情報システムを安全に管理する手段として利用されている。プロキシが中継することで、
　企業の端末が直接外部と接触しないため、セキュリティを強化できる。

・どのディレクティブが使えるの？

　どのタイプの設定セクションで度のディレクティブが使用できるかは、ディレクティブのcontextを確認する。
　<Directory>で使用可能な者は全て、同様に<DirectoryMatch>,<Files>,<FilesMatch>,<Location>,<LocationMatch>,
　<Proxy>,<ProxyMatch>セクションで使用可能。しかし以下のようにいくつか例外も存在する。

　　AllowOverrideディレクティブは<Directory>セクションでのみ使用可能。
　　FollowSymLinks と SymLinksIfOwnerMatch の Options は、<Directory>セクションか.htaccessファイルでのみ使用可能。
　　Optionsディレクティブは、<Files>と<FilesMatch>セクションでは使用できない。

・セクションのマージ方法

　マージの順番は以下のようになっている。

　　1.<Directory>(正規表現なし)と.htaccessを同時に(.htaccessが許可されていれば、それが<Directory>を上書きする)
　　2.<Directory>(と <Directory ~>)
　　3.<Files>と<FilesMatch>を同時に
　　4.<Location>と<LocationMatch>を同時に

　<Directory>以外は、それぞれのグループは設定ファイルに現れた順番に処理される。
　<Directory>(上のグループ1)はディレクトリが短いものから長いものへと処理される。
　例えば、<Directory /var/web/dir1>は<Directory /var/web/dir/subdir>の前に処理される。
　複数の<Directory>セクションが同じディレクトリに適用される場合は、設定ファイル中の順番に従って処理される。
　Includeによって挿入された設定は挿入しているファイルのIncludeディレクティブの位置にあったかのように扱われる。

　<VirtualHost>セクション中のセクションはバーチャルホストの定義の外側の対応するセクションの後に適用される。
　これによりバーチャルホストがメインのサーバ設定を上書きできるようになる。

　mod_proxyでリクエストが処理される場合は、処理順番の内、<Directory>コンテナの部分が<Proxy>コンテナにとってかわられる。

　後のセクションのディレクティブが前のセクションのものを上書きする。

　[技術メモ] 実際には、名前を変換する段階(URLをファイル名にマップするためにAliasやDocumentRootが使用されるところ)
　の直前に<Location>/<LocationMatch>が行われる。これらを適用した結果は変換が終わった後に完全に捨てられる。

　以下はマージの順番を示すための恣意的な例になっている。リクエスト全てに適用されるとして、本例のディレクティブは
　A -> B -> C -> D -> E の順番に適用される。

　　<Location />
    E
    </Location>

    <Files f.html>
    D
    </Files>

    <VirtualHost *>
    <Directory /a/b>
    B
    </Directory>
    </VirtualHost>

    <DirectoryMatch "^.*b$>
    C
    <DirectoryMatch>

    <Directory /a/b>
    A
    </Directory>

　もっと具体的な以下の例を考えてみる。<Directory>セクションに設置されたアクセス制限に関わらず、
　<Location>セクションが最後に評価されて、サーバへのアクセスは制限されない。
　このような結果から分かるように、マージの順番は重要なため、注意して使用する。

　　<Location />
    Order deny,allow
    Allow from all
    </Location>

    # Woops! This <Directory> section will have no effect
    <Directory />
    Order allow,deny
    Allow from all
    Deny from badguy.example.com
    </Directory>

============================================================================================================================

エラーやミス、わからないことなど

・httpd -k install コマンドでwindowsにapacheサービスをインストールしたとき、以下のようなエラーが出た。

　　C:\Windows\System32>httpd -k install
　　Installing the 'Apache2.4' service
　　The 'Apache2.4' service is successfully installed.
　　Testing httpd.conf....
　　Errors reported here must be corrected before the service can be started.
　　AH00558: httpd: Could not reliably determine the server's fully qualified domain name, 
　　using fe80::bb83:36d0:35ca:b0dc. Set the 'ServerName' directive globally to suppress this message

　→ 恐らく、httpd.confの設定をしていなかったため、このエラーが出たのだと思われる。